<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة سيد عباس الميكانيكي</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
    margin:0;
    font-family:'Cairo',sans-serif;
    direction:rtl;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:#fff;
}

/* Containers */
.login,.dashboard{
    max-width:1200px;
    margin:50px auto;
    background:rgba(255,255,255,.1);
    backdrop-filter:blur(12px);
    padding:30px;
    border-radius:18px;
    box-shadow:0 25px 50px rgba(0,0,0,.4);
}

h2{text-align:center;margin-bottom:20px}

input{
    width:100%;
    padding:14px;
    border:none;
    border-radius:10px;
    font-size:16px;
    margin-bottom:15px;
}

.login button{
    width:100%;
    padding:14px;
    border:none;
    border-radius:10px;
    background:#00c6ff;
    color:#000;
    font-size:18px;
    cursor:pointer;
}

/* Table */
table{
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
}

th{
    background:#00c6ff;
    color:#000;
    padding:12px;
}

td{
    padding:12px;
    border-bottom:1px solid rgba(255,255,255,.2);
    text-align:center;
}

tr:hover{background:rgba(255,255,255,.1)}

button{
    border:none;
    padding:6px 10px;
    border-radius:6px;
    cursor:pointer;
    color:#fff;
    font-size:13px;
    margin:2px;
}

.call{background:#28a745}
.accept{background:#17a2b8}
.reject{background:#dc3545}
.chat{background:#6f42c1}
.delete{background:#000}

/* Status */
.badge{
    padding:4px 8px;
    border-radius:6px;
    font-size:13px;
}
.pending{background:#ffc107;color:#000}
.accepted{background:#28a745}

/* Chat */
#chatBox{
    position:fixed;
    bottom:20px;
    left:20px;
    width:320px;
    height:430px;
    background:#111;
    border-radius:14px;
    display:none;
    flex-direction:column;
    box-shadow:0 0 30px #000;
    z-index:9999;
}

#chatHeader{
    padding:10px;
    background:#00c6ff;
    color:#000;
    font-weight:bold;
}

#chatMessages{
    flex:1;
    padding:10px;
    overflow-y:auto;
}

#chatInputBox{
    display:flex;
}

#chatInputBox input{
    flex:1;
    border:none;
    padding:10px;
}

#chatInputBox button{
    background:#00c6ff;
    color:#000;
    border:none;
    padding:10px 14px;
}

.msg-admin{
    text-align:right;
    margin:6px 0;
}
.msg-user{
    text-align:left;
    margin:6px 0;
}
.msg-admin span{
    background:#00c6ff;
    color:#000;
}
.msg-user span{
    background:#444;
    color:#fff;
}
.msg span{
    display:inline-block;
    padding:6px 10px;
    border-radius:8px;
}

.hidden{display:none}
</style>
</head>

<body>

<audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
<audio id="chatSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<!-- Login -->
<div class="login" id="loginBox">
    <h2>تسجيل الدخول</h2>
    <input type="password" id="password" placeholder="كلمة السر">
    <button onclick="login()">دخول</button>
</div>

<!-- Dashboard -->
<div class="dashboard hidden" id="app">
    <h2>أهلاً سيد عباس الميكانيكي – هاهم طلباتك</h2>

    <table>
        <thead>
            <tr>
                <th>الاسم</th>
                <th>الهاتف</th>
                <th>السيارة</th>
                <th>المشكلة</th>
                <th>التاريخ</th>
                <th>الوقت</th>
                <th>الحالة</th>
                <th>إجراءات</th>
            </tr>
        </thead>
        <tbody id="rows"></tbody>
    </table>
</div>

<!-- Chat Box -->
<div id="chatBox">
    <div id="chatHeader">
        الدردشة
        <span style="float:left;cursor:pointer" onclick="closeChat()">✖</span>
    </div>
    <div id="chatMessages"></div>
    <div id="chatInputBox">
        <input id="chatInput" placeholder="اكتب رسالة...">
        <button onclick="sendMessage()">إرسال</button>
    </div>
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCLCSPOV1nuk5RvQiSJcjc18rxXbC0Ei9Y",
  authDomain: "bot-djasser-achlaf-4494.firebaseapp.com",
  databaseURL: "https://bot-djasser-achlaf-4494-default-rtdb.firebaseio.com",
  projectId: "bot-djasser-achlaf-4494",
  storageBucket: "bot-djasser-achlaf-4494.firebasestorage.app",
  messagingSenderId: "500557963512",
  appId: "1:500557963512:web:a32bf5c21ba508662b5b0d"
});

const db = firebase.database();
let firstLoad=true;
let currentChatId=null;

/* Login */
function login(){
    if(password.value==="ABBAS VW1977"){
        loginBox.classList.add("hidden");
        app.classList.remove("hidden");
        listenAppointments();
    }else alert("كلمة السر غير صحيحة");
}

/* Appointments */
function listenAppointments(){
    const ref=db.ref("appointments");

    ref.on("value",snap=>{
        rows.innerHTML="";
        snap.forEach(c=>{
            const d=c.val();
            rows.innerHTML+=`
            <tr>
                <td>${d.name}</td>
                <td>${d.phone}</td>
                <td>${d.car}</td>
                <td>${d.issue}</td>
                <td>${d.date}</td>
                <td>${d.time}</td>
                <td>
                    <span class="badge ${d.status==="accepted"?"accepted":"pending"}">
                    ${d.status||"pending"}
                    </span>
                </td>
                <td>
                    <button class="call" onclick="call('${d.phone}')">اتصال</button>
                    <button class="accept" onclick="accept('${c.key}')">قبول</button>
                    <button class="reject" onclick="removeApp('${c.key}')">رفض</button>
                    <button class="chat" onclick="openChat('${c.key}')">دردشة</button>
                </td>
            </tr>`;
        });
        firstLoad=false;
    });

    ref.on("child_added",()=>{
        if(!firstLoad) alertSound.play();
    });
}

/* Actions */
function call(p){location.href="tel:"+p}
function accept(id){db.ref("appointments/"+id).update({status:"accepted"})}
function removeApp(id){if(confirm("حذف؟"))db.ref("appointments/"+id).remove()}

/* Chat */
function openChat(id){
    currentChatId=id;
    chatBox.style.display="flex";
    chatMessages.innerHTML="";
    db.ref("chats/"+id).off();
    db.ref("chats/"+id).on("child_added",snap=>{
        const m=snap.val();
        const div=document.createElement("div");
        div.className="msg "+(m.sender==="admin"?"msg-admin":"msg-user");
        div.innerHTML=`<span>${m.text}</span>`;
        chatMessages.appendChild(div);
        chatMessages.scrollTop=chatMessages.scrollHeight;
        if(m.sender==="user") chatSound.play();
    });
}

function closeChat(){
    chatBox.style.display="none";
    currentChatId=null;
}

function sendMessage(){
    if(!chatInput.value||!currentChatId)return;
    db.ref("chats/"+currentChatId).push({
        sender:"admin",
        text:chatInput.value,
        time:Date.now()
    });
    chatInput.value="";
}
</script>

</body>
</html>
